#!/usr/bin/env python3
"""Generate daily vision documentation from story-tree database."""

import sqlite3
import subprocess
from datetime import datetime, timezone
from pathlib import Path

from config import get_db_path, get_data_dir

# Paths
REPO_ROOT = Path(__file__).parent.parent.parent
DB_PATH = get_db_path()
TREE_SCRIPT = REPO_ROOT / "distributables/skills/story-tree/scripts/tree-view.py"
OUTPUT_DIR = get_data_dir() / "github_action_results"

def main():
    # Get tree visualization
    tree_output = subprocess.run(
        ["python", str(TREE_SCRIPT), "--show-capacity"],
        capture_output=True,
        text=True
    ).stdout

    # Connect to database
    conn = sqlite3.connect(str(DB_PATH))
    cursor = conn.cursor()

    # Get timestamp
    now = datetime.now(timezone.utc)
    timestamp = now.strftime('%Y-%m-%d %H:%M:%S UTC')
    date_str = now.strftime('%Y-%m-%d')

    # Get overall stats
    cursor.execute('SELECT COUNT(*) FROM story_nodes')
    total_stories = cursor.fetchone()[0]

    cursor.execute("""
        SELECT stage, COUNT(*)
        FROM story_nodes
        WHERE terminus IS NULL AND status = 'ready'
        GROUP BY stage
        ORDER BY
            CASE stage
                WHEN 'concept' THEN 1
                WHEN 'approved' THEN 2
                WHEN 'planned' THEN 3
                WHEN 'active' THEN 4
                WHEN 'reviewing' THEN 5
                WHEN 'verifying' THEN 6
                WHEN 'implemented' THEN 7
                WHEN 'ready' THEN 8
                WHEN 'polish' THEN 9
                WHEN 'released' THEN 10
            END
    """)
    active_by_stage = cursor.fetchall()

    cursor.execute("""
        SELECT terminus, COUNT(*)
        FROM story_nodes
        WHERE terminus IS NOT NULL
        GROUP BY terminus
    """)
    disposed = cursor.fetchall()

    cursor.execute("""
        SELECT status, COUNT(*)
        FROM story_nodes
        WHERE status != 'ready'
        GROUP BY status
    """)
    held = cursor.fetchall()

    conn.close()

    # Build the content
    content = f"""# SyncoPaid Story Tree Visualization

> Auto-generated visualization of story tree database

## Run Details

| Field | Value |
|-------|-------|
| Generated | {timestamp} |
| Total Stories | {total_stories} |

## Active Stories by Stage

| Stage | Count |
|-------|-------|
"""

    for stage, count in active_by_stage:
        content += f"| {stage} | {count} |\n"

    if held:
        content += "\n## Non-Ready Stories\n\n| Status | Count |\n|--------|-------|\n"
        for status, count in held:
            content += f"| {status} | {count} |\n"

    if disposed:
        content += "\n## Disposed Stories\n\n| Disposition | Count |\n|-------------|-------|\n"
        for disp, count in disposed:
            content += f"| {disp} | {count} |\n"

    content += f"""
## Tree Structure

```
{tree_output}```

---
*Generated by daily visualization workflow*
"""

    # Write output
    output_file = OUTPUT_DIR / f"{date_str}-tree-visualization.md"
    output_file.write_text(content)
    print(f"Generated: {output_file}")

if __name__ == "__main__":
    main()
